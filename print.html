<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Impression A4 – CA de Saint-Dié-des-Vosges</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    :root { --pad: 10mm; }

    html, body { margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: #111; }
    .page {
      width: 210mm;            /* A4 */
      min-height: 297mm;       /* A4 */
      box-sizing: border-box;
      padding: var(--pad);
    }

    header { display: flex; justify-content: space-between; align-items: baseline; gap: 10mm; }
    h1 { margin: 0; font-size: 16px; }
    .meta { font-size: 12px; color: #444; text-align: right; }

    .layout {
      margin-top: 6mm;
      display: grid;
      grid-template-columns: 1fr;
      gap: 6mm;
    }

    #map {
      width: 100%;
      height: 225mm;     /* hauteur optimisée pour A4 portrait */
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: hidden;
    }

    .legend {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 6mm;
    }
    .legend-title { font-weight: 600; margin: 0 0 4mm; font-size: 13px; }
    .legend-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3mm 8mm;
    }
    .legend-item { display: grid; grid-template-columns: 10mm 1fr; gap: 3mm; align-items: center; font-size: 12px; }
    .swatch { width: 10mm; height: 6mm; border: 1px solid rgba(0,0,0,.25); border-radius: 2mm; }

    .note { font-size: 11px; color: #555; margin-top: 4mm; }

    .actions { margin-top: 6mm; display: flex; gap: 8px; flex-wrap: wrap; }
    button, a.btn {
      padding: 10px 12px;
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 10px;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      font-size: 14px;
    }
    button:hover, a.btn:hover { background: #f7f7f7; }

    @page { size: A4 portrait; margin: 0; }
    @media print {
      .actions { display: none !important; }
      .leaflet-control-container { display: none !important; }
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <h1>Communauté d’agglomération de Saint-Dié-des-Vosges – Carte</h1>
      <div class="meta">
        <div id="dateLine"></div>
        <div style="margin-top:2mm;">Format : A4 portrait</div>
      </div>
    </header>

    <div class="layout">
      <div id="map"></div>

      <div class="legend">
        <p class="legend-title">Légende</p>
        <div class="legend-grid" id="legendGrid"></div>
        <div class="note">
          Cette page reprend vos couleurs/étiquettes depuis la sauvegarde du navigateur (bouton “Sauvegarder” sur la carte principale).
          Si vos couleurs ne sont pas là, ouvrez la carte principale → “Recharger la sauvegarde”, puis revenez ici.
        </div>
      </div>

      <div class="actions">
        <button id="btnPrint">Imprimer / Enregistrer en PDF</button>
        <a class="btn" href="./">Retour à la carte</a>
      </div>
    </div>
  </div>

<script>
(() => {
  const EPCI_CODE = "200071066";
  const STORAGE_KEY = "ca_saintdie_coloriage_v1";

  // Date
  const d = new Date();
  document.getElementById("dateLine").textContent = "Édité le " + d.toLocaleDateString("fr-FR");

  // Sauvegarde (catégories + état)
  let categories = [
    { id: "none", label: "Non renseigné", color: "#ffffff" },
    { id: "cat1", label: "Catégorie 1",   color: "#fde68a" },
    { id: "cat2", label: "Catégorie 2",   color: "#a7f3d0" },
    { id: "cat3", label: "Catégorie 3",   color: "#bfdbfe" },
    { id: "cat4", label: "Catégorie 4",   color: "#fbcfe8" },
  ];
  const communeState = new Map();

  function loadSaved() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      const payload = JSON.parse(raw);
      if (Array.isArray(payload.categories)) categories = payload.categories;
      if (payload.state && typeof payload.state === "object") {
        Object.entries(payload.state).forEach(([k, v]) => {
          if (typeof v === "number") communeState.set(k, v);
        });
      }
    } catch (e) {}
  }

  function renderLegend() {
    const grid = document.getElementById("legendGrid");
    grid.innerHTML = "";
    categories.forEach(cat => {
      const item = document.createElement("div");
      item.className = "legend-item";
      const sw = document.createElement("div");
      sw.className = "swatch";
      sw.style.background = cat.color;
      const lab = document.createElement("div");
      lab.textContent = cat.label;
      item.appendChild(sw);
      item.appendChild(lab);
      grid.appendChild(item);
    });
  }

  function getIdx(code) {
    const v = communeState.get(code);
    return (typeof v === "number") ? v : 0;
  }

  function styleCommune(feature) {
    const code = feature.properties?.code;
    const idx = getIdx(code);
    const cat = categories[idx] ?? categories[0];
    return {
      weight: 1,
      color: "#333",
      opacity: 0.85,
      fillColor: cat.color,
      fillOpacity: (String(cat.color).toLowerCase() === "#ffffff") ? 0.08 : 0.70
    };
  }

  // Carte Leaflet (stable pour impression)
  const map = L.map('map', {
    zoomControl: false,
    dragging: false,
    scrollWheelZoom: false,
    doubleClickZoom: false,
    boxZoom: false,
    keyboard: false,
    tap: false,
    touchZoom: false
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const epciUrl = `https://geo.api.gouv.fr/epcis/${EPCI_CODE}?format=geojson&geometry=contour`;
  const communesUrl = `https://geo.api.gouv.fr/epcis/${EPCI_CODE}/communes?fields=nom,code,centre&format=geojson&geometry=contour`;

  async function load() {
    loadSaved();
    renderLegend();

    const [eRes, cRes] = await Promise.all([fetch(epciUrl), fetch(communesUrl)]);
    if (!eRes.ok) throw new Error("Erreur chargement EPCI");
    if (!cRes.ok) throw new Error("Erreur chargement communes");

    const epciGeo = await eRes.json();
    const communesGeo = await cRes.json();

    const epciLayer = L.geoJSON(epciGeo, { style: { color: "#111", weight: 3, fillOpacity: 0 } }).addTo(map);
    L.geoJSON(communesGeo, { style: styleCommune }).addTo(map);

    // Labels (noms) — robuste
    const labelsLayer = L.layerGroup().addTo(map);
    communesGeo.features.forEach(f => {
      const nom = f.properties?.nom;
      if (!nom) return;

      const centre = f.properties?.centre?.coordinates; // [lng, lat]
      let latlng = null;

      if (centre && centre.length === 2) {
        latlng = L.latLng(centre[1], centre[0]);
      } else {
        const tmp = L.geoJSON(f);
        latlng = tmp.getBounds().getCenter();
      }

      const icon = L.divIcon({
        className: "commune-label",
        html: `<div style="
          font-size: 8px;
          line-height: 1.05;
          padding: 1px 2px;
          background: rgba(255,255,255,.70);
          border: 1px solid rgba(0,0,0,.22);
          border-radius: 6px;
          white-space: nowrap;
        ">${nom}</div>`
      });

      L.marker(latlng, { icon, interactive: false }).addTo(labelsLayer);
    });

    // Cadrage
    map.fitBounds(epciLayer.getBounds(), { padding: [10, 10] });

    // Important pour l’impression (Leaflet aime bien ça)
    setTimeout(() => {
      map.invalidateSize();
      map.fitBounds(epciLayer.getBounds(), { padding: [10, 10] });
    }, 250);
  }

  load().catch(err => {
    console.error(err);
    alert("La carte d’impression n’a pas pu se charger. (Voir console F12)");
  });

  document.getElementById("btnPrint").addEventListener("click", () => {
    setTimeout(() => window.print(), 300);
  });
})();
</script>
</body>
</html>
